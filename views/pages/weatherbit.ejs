<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('./../partials/head'); %>
</head>

<body class="container">
  <header>
    <%- include('./../partials/header'); %>
  </header>
  <main>
    <br />
    <div>
      <fieldset>
        <form action="/weatherbit" method="post">
          <label for="locale">Address(default to GSP coords if empty):</label>
          <input name="locale" type="text" class="ghost-input" placeholder="Enter a City.">
          <input type="hidden" id="lat" name="lat" value="">
          <input type="hidden" id="lng" name="lng" value="">
          <input type="submit" class="btn btn-sm btn-outline-success ghost-button" value="Pinpoint Weather">
        </form>        
      </fieldset>
      <hr />
    </div>

    <div class="row">
      <div class="col-sm-6">
        <h5>Current Conditions</h5>
        <div class="jumbotron jumbotron-fluid">
          <% if( typeof(error)==="undefined" || curStatus===400 ){ %>
            <p style="color:gray"> Waiting for data.</p>
            <% } else { %>
              <p style="color:gray"><strong>City</strong>: <%= curData.city_name %> , <%= curData.state_code %>
                <br />
                  <strong>Geolocation</strong>: <%= curData.lat %>, <%= curData.lon %>
                <br />
                <strong>Time zone: </strong>
                <%= curData.timezone %>
                <br />
                <hr />
              </p>
              <table class="styled-table">
                <tr class="active-row">
                  <th>Datetime: </th>
                  <td>
                    <%= curData.ob_time %>
                  </td>
                </tr>
                <th>Cloud cover(%): </th>
                <td>
                  <%= curData.clouds %>
                </td>
                </tr>
                <th>Temperature(F): </th>
                <td>
                  <%= curData.temp %>
                </td>
                </tr>
                <th>Feels like(F): </th>
                <td>
                  <%= curData.app_temp %>
                </td>
                </tr>
                <th>Relative humidity (%): </th>
                <td>
                  <%= curData.rh %>
                </td>
                </tr>
                <th>Visibility: </th>
                <td>
                  <%= curData.vis %>
                </td>
                </tr>
                <th>Pressure(mb): </th>
                <td>
                  <%= curData.pres %>
                </td>
                </tr>
                <th>Sea Level Pressure(mb): </th>
                <td>
                  <%= curData.slp %>
                </td>
                </tr>
                <th>Wind Speed(m/s): </th>
                <td>
                  <%= curData.wind_spd %>
                </td>
                </tr>
                <th>Wind Direction: </th>
                <td>
                  <%= curData.wind_cdir_full %>
                </td>
                </tr>
                <th>Snowfall(mm/hr): </th>
                <td>
                  <%= curData.snow %>
                </td>
                </tr>
                <th>UV Index: </th>
                <td>
                  <%= curData.uv %>
                </td>
                </tr>
                <th>Air Quality Index: </th>
                <td>
                  <%= curData.aqi %>
                </td>
                </tr>
                <th>Sunrise: </th>
                <td>
                  <%= curData.sunrise %>
                </td>
                </tr>
                <th>Sunset: </th>
                <td>
                  <%= curData.sunset %>
                </td>
                </tr>
              </table>

              <% } %>
        </div>
      </div>



        <div class="col-sm-6">
          <h5>Current Air Quality</h5>
          <div class="jumbotron jumbotron-fluid">
            <% if( typeof(error)==="undefined" || airqStatus===400 ) { %>
              <p style="color:gray"> Waiting for data.</p>
              <% } else { %>
                <p style="color:gray"><strong>Local hourly</strong>: <%= airqData.timestamp_local.split('T')[1] %> 
                  <br />
 
                </p>     
                <hr />           
                <table class="styled-table">
                  <tr>
                    <th>Air Quality Index: </th>
                    <td>
                      <%= airqData.aqi %>
                    </td>
                  </tr>
                  <tr>
                    <th>O3 Concentration(µg/m³): </th>
                    <td>
                      <%= airqData.o3 %>
                    </td>
                  </tr>
                  <tr>
                    <th>SO2 Concentration(µg/m³): </th>
                    <td>
                      <%= airqData.so2 %>
                    </td>
                  </tr>
                  <tr>
                    <th>NO2 Concentration(µg/m³): </th>
                    <td>
                      <%= airqData.no2 %>
                    </td>
                  </tr>
                  <tr>
                    <th>Carbon monoxide (µg/m³): </th>
                    <td>
                      <%= airqData.co %>
                    </td>
                  </tr>
                  <tr>                   
                    <th>Particulate matter 2.5microns(µg/m³): </th>
                    <td>
                      <%= airqData.pm25 %>
                    </td>
                  </tr>
                  <tr>                    
                    <th>Particulate matter 10microns(µg/m³): </th>
                    <td>
                      <%= airqData.pm10 %>
                    </td>
                  </tr>
                </table>
                <% } %>
          </div>
        </div>
      </div>
    </div>
    

    <div class="row">
      <div class="col-sm-12">
        <h5>Extended Forecast</h5>
        <div class="jumbotron jumbotron-fluid">
          <% if( typeof(error)==="undefined" || foreStatus===400 ){ %>
            <p style="color:gray"> Waiting for data.</p>
            <% } else { %>
              <table class="styled-table">
                <thead>
                  <tr class="w-35">
                    <th>Date</th>
                    <th>Condition</th>
                    <th>Max/Min Temperature</th>
                    <th>Temperature(F)</th>
                    <th>Pressure</th>
                    <th>Humidity</th>
                    <th>Wind Gust</th>
                    <th>Wind Speed</th>
                    <th>Wind Direction</th>
                    <th>Cloud Cover</th>
                    <th>Visibility</th>
                    <th>UV Index</th>
                    <th>Sunrise/Sunset</th>
                    <th>Moonphase</th>
                  </tr>
                </thead>
                <% let forecast=foreData.data; %>
                  <% for (let i=0; i < forecast.length; i++) { %>
                    <tbody>
                      <tr class="active-row">
                        <td>
                          <%= forecast[i].datetime %>
                        </td>
                        <td>
                          <%= forecast[i].weather.description %>
                        </td>
                        <td>
                          <%= forecast[i].app_max_temp %> , <%= forecast[i].app_min_temp %>
                        </td>
                        <td>
                          <%= forecast[i].temp %>
                        </td>
                        <td>
                          <%= forecast[i].slp %>
                        </td>
                        <td>
                          <%= forecast[i].rh %>
                        </td>
                        <td>
                          <%= forecast[i].windgust %>
                        </td>
                        <td>
                          <%= forecast[i].wind_spd %>
                        </td>
                        <td>
                          <%= forecast[i].wind_gust_spd %>
                        </td>
                        <td>
                          <%= forecast[i].wind_cdir_full %>
                        </td>
                        <td>
                          <%= forecast[i].clouds %>
                        </td>
                        <td>
                          <%= forecast[i].vis %>
                        </td>
                        <td>
                          <%= forecast[i].uv %>
                        </td>
                        <td>
                          <%= forecast[i].sunrise_ts %> , <%= forecast[i].sunset_ts %>
                        </td>
                        <td>
                          <%= forecast[i].moon_phase_lunation %>
                        </td>
                      </tr>
                    </tbody>
                    <% }} %>
              </table>
        </div>

      </div>

    </div>
    <% let longi, lati = "" %>
    <script>
      let longi, lati = "";
      function getGeoLocation() {
    
        // Store the element where the page displays the result
        lati = document.getElementsByName("lat");
        longi = document.getElementsByName("lng");
        
        // If geolocation is available, try to get the visitor's position
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
        } else {
            alert("Sorry, your browser does not support HTML5 geolocation.");
        }
      }

      // Define callback function for successful attempt
      function successCallback(position) {
        document.getElementById("lng").value = position.coords.longitude;
        document.getElementById("lat").value = position.coords.latitude;
      }

      // Define callback function for failed attempt
      function errorCallback(error) {
        let msg = "";
        let result = document.getElementById('geoResult');
        if(error.code == 1) {
            msg += "You've decided not to share your position, but it's OK. We won't ask you again.  ";
        } else if(error.code == 2) {
            msg += "The network is down or the positioning service can't be reached.  ";
        } else if(error.code == 3) {
            msg += "The attempt timed out before it could get the location data.  ";
        } else {
            msg += "Geolocation failed due to unknown error.  ";
        }
        //DISABLED FOR NOW if (msg.length > 0) { alert(msg); }
      }

      // Client-side invokes function to get Navigator.geolocation values
      getGeoLocation();
    </script>

  </main>
  <footer>
    <%- include('./../partials/footer'); %>
  </footer>
</body>

</html>